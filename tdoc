#!/data/data/com.termux/files/usr/bin/bash
#
# TDOC — Termux Doctor
#
# Copyright (c) 2026 TDOC Contributors
# Licensed under the MIT License.
#

set -o errexit
set -o nounset
set -o pipefail

export TDOC_ROOT="${PREFIX}/lib/tdoc"

# Sanity check
if [[ ! -d "$TDOC_ROOT/core" ]]; then
  echo "TDOC installation corrupted: $TDOC_ROOT/core not found" >&2
  exit 127
fi

# Init
source "$TDOC_ROOT/core/init.sh"

cmd="${1:-status}"

case "$cmd" in

  version|-v|--version)
    tdoc_version_string
    ;;

  scan)
    source "$TDOC_ROOT/core/scan.sh"
    echo
    echo "✔ TDOC scan completed"
    ;;

  fix)
    source "$TDOC_ROOT/core/scan.sh"
    case "${2:-}" in
      --preview)
        source "$TDOC_ROOT/core/fix_preview.sh"
        ;;
      --auto)
        source "$TDOC_ROOT/core/fix_auto.sh"
        ;;
      *)
        source "$TDOC_ROOT/core/fix.sh"
        ;;
    esac
    ;;

  doctor)
    case "${2:-}" in
      --json)
        source "$TDOC_ROOT/core/scan.sh" >/dev/null 2>&1
        source "$TDOC_ROOT/core/doctor_json.sh"
        ;;
      *)
        echo "Usage:"
        echo "  tdoc doctor --json"
        ;;
    esac
    ;;

  explain)
    source "$TDOC_ROOT/core/scan.sh"
    source "$TDOC_ROOT/core/explain.sh"
    ;;

  report)
    source "$TDOC_ROOT/core/scan.sh"
    cat "$TDOC_ROOT/data/state.env"
    ;;

  ""|status)
    source "$TDOC_ROOT/core/scan.sh"
    source "$TDOC_ROOT/core/status.sh"
    ;;

  update)
    echo "TDOC is updated via Termux package manager."
    echo
    echo "Run:"
    echo "  pkg update"
    echo "  pkg upgrade tdoc"
    ;;

  security)
    case "${2:-}" in
      --json)
        source "$TDOC_ROOT/core/repo_security_json.sh"
        ;;
      *)
        source "$TDOC_ROOT/core/repo_security_ui.sh"
        ;;
    esac
    ;;

  help|-h|--help)
    echo "Termux Doctor"
    echo "Version: v$TDOC_VERSION ($TDOC_CODENAME)"
    echo
    echo "Usage:"
    echo "  tdoc scan              Run system scan only"
    echo "  tdoc status            Scan + show status"
    echo "  tdoc version"
    echo "  tdoc explain"
    echo "  tdoc fix"
    echo "  tdoc fix --preview"
    echo "  tdoc fix --auto"
    echo "  tdoc report"
    echo "  tdoc doctor --json"
    echo "  tdoc security"
    echo "  tdoc security --json"
    echo "  tdoc update    (via pkg)"
    echo "  tdoc help"
    ;;

  *)
    echo "Unknown command: tdoc $cmd" >&2
    echo "Run: tdoc help" >&2
    exit 1
    ;;
esac
